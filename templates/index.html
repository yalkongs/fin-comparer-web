<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²½ìŸì‚¬ ìƒí’ˆ ë¶„ì„ | iMë±…í¬ ê¸°ì¤€ ê²½ìŸë ¥ í‰ê°€</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #0b0e14;
            --sidebar: #12161f;
            --accent: #4f46e5;
            --accent-glow: rgba(79, 70, 229, 0.4);
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --card: rgba(30, 41, 59, 0.5);
            --border: rgba(255, 255, 255, 0.08);
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --glass: rgba(255, 255, 255, 0.03);
            --info: #3b82f6;
            --im-bank: #26d9d1;
            /* iM Bank Primary Mint Color */
            --im-highlight: #26d9d1;
            /* Highlighting also using mint */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Outfit', 'Noto Sans KR', sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        aside {
            width: 280px;
            background: var(--sidebar);
            border-right: 1px solid var(--border);
            padding: 40px 24px;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 40px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-box {
            width: 36px;
            height: 36px;
            background: var(--accent);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px var(--accent-glow);
        }

        nav {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 14px 20px;
            border-radius: 12px;
            text-align: left;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
        }

        .nav-btn.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .data-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-left: auto;
        }

        .dot-true {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .dot-false {
            background: var(--text-muted);
            opacity: 0.3;
        }

        /* Main Area */
        main {
            flex: 1;
            padding: 48px;
            overflow-y: auto;
            background: radial-gradient(circle at top right, #1e293b22, transparent);
            padding-bottom: 120px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            background: var(--glass);
            padding: 16px 24px;
            border-radius: 20px;
            border: 1px solid var(--border);
        }

        .calc-box {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .calc-input {
            background: transparent;
            border: none;
            color: var(--success);
            font-weight: 700;
            width: 120px;
            font-size: 1rem;
            text-align: right;
            border-bottom: 1px solid var(--success);
        }

        .calc-input:focus {
            outline: none;
        }

        /* Dashboard Highlights */
        .dash-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .dash-card {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 24px;
            border-radius: 24px;
            text-align: center;
        }

        .dash-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .dash-val {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--accent);
        }

        /* Grid Cards */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
        }

        .grid.list {
            grid-template-columns: 1fr;
        }

        .grid.list .card {
            display: flex;
            align-items: center;
            padding: 15px 28px;
            gap: 20px;
        }

        .grid.list .card .prod-name {
            margin: 0 !important;
            min-height: auto !important;
            flex: 1;
        }

        .grid.list .card .bank-tag-container {
            width: 150px;
        }

        .grid.list .card .rate-container {
            width: 180px;
            text-align: right;
            margin-bottom: 0 !important;
        }

        .grid.list .card .profit-container {
            width: 200px;
            background: none !important;
            padding: 0 !important;
        }

        .grid.list .card .im-badge {
            top: 50%;
            right: -10px;
            transform: translateY(-50%);
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 28px;
            backdrop-filter: blur(10px);
            transition: 0.3s;
            position: relative;
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-8px);
            border-color: var(--accent);
            background: rgba(30, 41, 59, 0.8);
        }

        /* iM Bank Highlight Style */
        .card.im-highlight {
            border: 2px solid var(--im-highlight);
            box-shadow: 0 0 20px rgba(38, 217, 209, 0.2);
            background: rgba(38, 217, 209, 0.08);
        }

        .im-badge {
            position: absolute;
            top: -10px;
            right: 20px;
            background: var(--im-highlight);
            color: #000;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 800;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .check-box {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 22px;
            height: 22px;
            border-radius: 6px;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .card.selected .check-box {
            background: var(--accent);
            border-color: var(--accent);
        }

        .card.selected .check-box::after {
            content: 'âœ“';
            color: white;
            font-weight: 800;
        }

        .trend-up {
            color: var(--success);
            font-size: 0.8rem;
            margin-left: 6px;
        }

        .trend-down {
            color: var(--error);
            font-size: 0.8rem;
            margin-left: 6px;
        }

        .diff-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 10px;
        }

        .diff-1 {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .diff-2 {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .diff-3 {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
        }

        /* Compare Drawer */
        #compareDrawer {
            position: fixed;
            bottom: 0;
            left: 280px;
            right: 0;
            background: var(--sidebar);
            border-top: 1px solid var(--accent);
            padding: 20px 48px;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(20px);
        }

        #compareDrawer.active {
            transform: translateY(0);
        }

        .compare-items {
            display: flex;
            gap: 20px;
        }

        .comp-tag {
            background: var(--glass);
            padding: 10px 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .comp-tag button {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
        }

        /* Modal Overlays */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--sidebar);
            width: 90%;
            max-width: 800px;
            border-radius: 32px;
            border: 1px solid var(--border);
            padding: 48px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .comp-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2px;
            background: var(--border);
            border: 1px solid var(--border);
            margin-top: 30px;
        }

        .comp-cell {
            background: var(--sidebar);
            padding: 15px;
            font-size: 0.9rem;
        }

        .cell-head {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 700;
            color: var(--text-muted);
        }

        /* Mobile Responsiveness */
        @media (max-width: 1024px) {
            body {
                flex-direction: column;
            }

            aside {
                width: 100%;
                height: auto;
                padding: 20px;
                position: sticky;
                top: 0;
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
                border-bottom: 1px solid var(--border);
                border-right: none;
            }

            .logo {
                margin-bottom: 0;
            }

            nav {
                display: none;
            }

            /* Hide heavy menu on mobile or use hamburger */
            main {
                padding: 20px;
            }

            .dash-row {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                gap: 20px;
            }

            #compareDrawer {
                left: 0;
                padding: 15px;
            }

            .comp-tag {
                display: none;
            }

            /* Hide tags to save space */
        }

        @media (max-width: 640px) {
            .logo span {
                display: none;
            }

            .toolbar {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <aside>
        <div class="logo">
            <div class="logo-box">iM</div><span>ê²½ìŸì‚¬ ìƒí’ˆ ë¶„ì„</span>
        </div>
        <nav id="sidebarNav">
            <button class="nav-btn active" data-cat="deposit"><span>ğŸ’° ì •ê¸°ì˜ˆê¸ˆ</span>
                <div class="data-dot" id="dot-deposit"></div>
            </button>
            <button class="nav-btn" data-cat="saving"><span>ğŸ“ˆ ì ê¸ˆ ìƒí’ˆ</span>
                <div class="data-dot" id="dot-saving"></div>
            </button>
            <button class="nav-btn" data-cat="credit_general"><span>ğŸ’³ ì‹ ìš©ëŒ€ì¶œ(ì¼ë°˜)</span>
                <div class="data-dot" id="dot-credit_general"></div>
            </button>
            <button class="nav-btn" data-cat="credit_limit"><span>ğŸ“‰ ë§ˆì´ë„ˆìŠ¤í†µì¥</span>
                <div class="data-dot" id="dot-credit_limit"></div>
            </button>
            <button class="nav-btn" data-cat="demand"><span>ğŸ¦ ì…ì¶œê¸ˆ (ë³´í†µì˜ˆê¸ˆ)</span>
                <div class="data-dot" id="dot-demand"></div>
            </button>
        </nav>

        <div style="margin-top: auto; padding-top: 20px; display: flex; gap: 10px;">
            <button id="mobileMenuToggle"
                style="display: none; padding: 10px; background: var(--glass); border: 1px solid var(--border); border-radius: 8px; color: var(--text);">â˜°</button>
            <button id="openUploadBtn"
                style="flex: 1; padding: 12px; border-radius: 12px; border: 1px dashed var(--accent); background: rgba(79, 70, 229, 0.1); color: var(--text); font-weight: 700; cursor: pointer; font-size: 0.8rem;">
                ğŸ“‚ ë°ì´í„° ì—…ë¡œë“œ
            </button>
        </div>
        <div class="desktop-only" style="margin-top: 20px; text-align: center;">
            <div id="lastUpdateIdx" style="font-size: 0.7rem; color: var(--accent);">2026-01-06 00:00:00</div>
        </div>
    </aside>

    <main>
        <header>
            <div>
                <h1 id="viewTitle" style="font-size: 1.8rem;">ì •ê¸°ì˜ˆê¸ˆ ìµœì  ê¸ˆë¦¬ ë¶„ì„</h1>
                <p style="color: var(--text-muted); margin-top: 4px; font-size: 0.9rem;">iMë±…í¬ ëŒ€ë¹„ ê²½ìŸì‚¬ ìƒí’ˆì˜ ê¸ˆë¦¬ ê²½ìŸë ¥ì„ í‰ê°€í•©ë‹ˆë‹¤.
                </p>
            </div>
            <div class="calc-box">
                <span style="font-size: 0.8rem; color: var(--text-muted);">ê¸°ì¤€ê¸ˆì•¡:</span>
                <input type="text" id="globalAmount" class="calc-input" value="10,000,000">
                <span style="font-size: 0.8rem; color: var(--text-muted);">ì›</span>
            </div>
        </header>

        <div id="dashContainer" class="dash-row">
            <!-- Sector Analysis will follow here -->
        </div>

        <div class="toolbar">
            <div style="display: flex; gap: 8px;">
                <button class="toggle-btn active" id="gridToggle"
                    style="padding: 8px 16px; border-radius: 8px; border: none; background: var(--accent); color: white; cursor: pointer;">ê·¸ë¦¬ë“œ
                    ë·°</button>
                <button class="toggle-btn" id="listToggle"
                    style="padding: 8px 16px; border-radius: 8px; border: none; background: transparent; color: var(--text-muted); cursor: pointer;">ë¦¬ìŠ¤íŠ¸
                    ë·°</button>
            </div>
            <div style="display:flex; gap:15px; align-items:center;">
                <span id="selectCount" style="font-size:0.85rem; color:var(--text-muted);">0ê°œ ì„ íƒë¨</span>
                <select id="termSelect"
                    style="background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 8px 12px; border-radius: 8px;">
                    <option value="12">12ê°œì›” ê¸°ì¤€</option>
                    <option value="24">24ê°œì›” ê¸°ì¤€</option>
                    <option value="36">36ê°œì›” ê¸°ì¤€</option>
                </select>
            </div>
        </div>

        <div id="productGrid" class="grid"></div>
        <div id="emptyView" class="empty-state"
            style="padding:100px; text-align:center; color:var(--text-muted); display:none;">
            <h2>í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</h2>
            <p style="margin-top:10px;">ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”.</p>
        </div>

        <footer
            style="margin-top: 100px; padding: 40px 0; border-top: 1px solid var(--border); text-align: center; color: var(--text-muted); font-size: 0.85rem;">
            <p>Written by í™©ì›ì²  with Antigravity</p>
        </footer>
    </main>

    <!-- Compare Drawer -->
    <div id="compareDrawer">
        <div class="compare-items" id="compItems"></div>
        <button id="startCompBtn"
            style="padding: 14px 28px; border-radius: 14px; border: none; background: var(--accent); color: white; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px var(--accent-glow);">
            ìƒí’ˆ ë¹„êµí•˜ê¸° (0/3)
        </button>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" id="closeUpload"
                style="position:absolute; top:30px; right:40px; font-size:2rem; cursor:pointer;">&times;</span>
            <h2 style="font-size: 1.5rem; margin-bottom: 10px;">ë°ì´í„° ì—…ë¡œë“œ</h2>
            <p style="color: var(--text-muted); font-size: 0.9rem;">ê¸ˆê°ì› ê³µì‹œ ì—‘ì…€ íŒŒì¼ì„ ì¹´í…Œê³ ë¦¬ì— ë§ì¶° ì—…ë¡œë“œí•˜ì„¸ìš”.</p>

            <div
                style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-top: 15px; font-size: 0.8rem; color: var(--text-muted);">
                <strong>ğŸ’¡ í•„ìˆ˜ ì»¬ëŸ¼ ì•ˆë‚´:</strong><br>
                - ê¸ˆìœµíšŒì‚¬ëª…, ê¸ˆìœµìƒí’ˆëª… (í•„ìˆ˜)<br>
                - ì €ì¶• ê¸ˆë¦¬, ìµœê³  ìš°ëŒ€ê¸ˆë¦¬ (ì˜ˆì ê¸ˆ)<br>
                - ìµœì € ê¸ˆë¦¬, ìµœê³  ê¸ˆë¦¬ (ëŒ€ì¶œ)
            </div>

            <div style="margin-top: 25px;">
                <label style="display: block; font-size: 0.85rem; margin-bottom: 8px; color: var(--text-muted);">1. ì¹´í…Œê³ ë¦¬
                    ì„ íƒ</label>
                <select id="uploadCategory"
                    style="width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 14px; border-radius: 14px; font-family: inherit;">
                    <option value="deposit">ì •ê¸°ì˜ˆê¸ˆ</option>
                    <option value="saving">ì ê¸ˆ</option>
                    <option value="credit">ê°œì¸ì‹ ìš©ëŒ€ì¶œ (í†µí•©)</option>
                    <option value="demand">ì…ì¶œê¸ˆ (ë³´í†µì˜ˆê¸ˆ)</option>
                </select>
            </div>

            <div id="dropZone"
                style="margin-top:20px; border: 2px dashed var(--border); border-radius: 20px; padding: 40px; text-align: center; transition: 0.3s; cursor: pointer;">
                <div style="font-size: 2.5rem; margin-bottom: 10px;">ğŸ“„</div>
                <p id="fileNameDisplay">íŒŒì¼ì„ ì´ë¦¬ë¡œ ëŒì–´ì˜¤ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒ</p>
                <input type="file" id="fileInput" hidden accept=".xlsx, .xls">
            </div>

            <button id="submitUpload"
                style="width:100%; margin-top:25px; padding:18px; border-radius:14px; border:none; background:var(--accent); color:white; font-weight:700; cursor:pointer;">ë°ì´í„°
                ì—…ë°ì´íŠ¸ ì‹œì‘</button>
            <div id="statusMsg" style="margin-top:15px; text-align:center; font-size:0.9rem;"></div>
        </div>
    </div>

    <div id="detailModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" id="closeDetail"
                style="position:absolute; top:30px; right:40px; font-size:2rem; cursor:pointer;">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <div id="compModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 1000px;">
            <h2 style="margin-bottom: 20px;">ğŸ“Š ì„ íƒ ìƒí’ˆ ìƒì„¸ ë¹„êµ</h2>
            <div id="compGridContainer"></div>
            <button onclick="document.getElementById('compModal').style.display='none'"
                style="width:100%; margin-top:30px; padding:18px; border-radius:14px; border:none; background:var(--glass); color:var(--text); cursor:pointer;">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        let currentCat = 'deposit';
        let currentTerm = 12;
        let productsData = [];
        let selectedItems = [];

        const catNames = {
            'deposit': 'ì •ê¸°ì˜ˆê¸ˆ ìµœì  ê¸ˆë¦¬ ë¶„ì„', 'saving': 'ì ê¸ˆ ìƒí’ˆ ìµœê³  ê¸ˆë¦¬ ë¶„ì„',
            'credit_general': 'ì¼ë°˜ì‹ ìš©ëŒ€ì¶œ ìµœì € ê¸ˆë¦¬ ë¶„ì„', 'credit_limit': 'ë§ˆì´ë„ˆìŠ¤í†µì¥ ìµœì € ê¸ˆë¦¬ ë¶„ì„', 'demand': 'ì…ì¶œê¸ˆ ìƒí’ˆ ë¹„êµ'
        };

        const diffText = { 1: "ì‰¬ì›€", 2: "ë³´í†µ", 3: "ì–´ë ¤ì›€" };

        async function fetchStatus() {
            const res = await fetch('/api/status');
            const data = await res.json();
            document.getElementById('lastUpdateIdx').textContent = data.last_updated || 'ì—…ë¡œë“œ ê¸°ë¡ ì—†ìŒ';

            // Update dots
            const cats = ['deposit', 'saving', 'credit_general', 'credit_limit', 'demand'];
            cats.forEach(c => {
                const dot = document.getElementById(`dot-${c}`);
                if (dot) {
                    const hasData = data.categories && data.categories[c] > 0;
                    dot.className = `data-dot dot-${hasData}`;
                }
            });
        }

        async function fetchAnalysis() {
            const res = await fetch(`/api/analysis?category=${currentCat}&term=${currentTerm}`);
            const data = await res.json();
            const container = document.getElementById('dashContainer');
            container.innerHTML = '';
            data.forEach(s => {
                container.innerHTML += `
                    <div class="dash-card">
                        <div class="dash-label">${s.sector} í‰ê·  ê¸ˆë¦¬ (${s.count}ê°œ)</div>
                        <div class="dash-val">${s.avg_rate.toFixed(2)}%</div>
                    </div>
                `;
            });
        }

        async function fetchProducts() {
            const res = await fetch(`/api/products?category=${currentCat}&term=${currentTerm}`);
            productsData = await res.json();
            render();
            fetchAnalysis();
            fetchStatus();
        }

        function render() {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = '';

            if (productsData.length === 0) {
                document.getElementById('emptyView').style.display = 'block';
                return;
            }
            document.getElementById('emptyView').style.display = 'none';

            const amount = parseInt(document.getElementById('globalAmount').value.replace(/,/g, '')) || 10000000;

            productsData.forEach((p, idx) => {
                const isSelected = selectedItems.find(item => item.id === p.id);
                const isImBank = p.bank.includes('iM') || p.bank.includes('ì•„ì´ì— ') || p.bank.includes('ëŒ€êµ¬ì€í–‰');

                const trend = p.rate2 > p.prev_rate ? `<span class="trend-up">â–² ${(p.rate2 - p.prev_rate).toFixed(2)}%</span>`
                    : p.rate2 < p.prev_rate ? `<span class="trend-down">â–¼ ${(p.prev_rate - p.rate2).toFixed(2)}%</span>` : '';

                const realProfit = Math.floor(amount * (p.rate2 / 100) * (1 - 0.154));
                const profitText = currentCat.includes('credit') ? 'ì˜ˆìƒ ì´ìë¹„ìš©' : 'ë§Œê¸° ì‹¤ìˆ˜ë ¹(ì´ì)';

                const card = document.createElement('div');
                card.className = `card ${isSelected ? 'selected' : ''} ${isImBank ? 'im-highlight' : ''}`;
                card.innerHTML = `
                    ${isImBank ? '<div class="im-badge">iMë±…í¬ (ê¸°ì¤€)</div>' : ''}
                    <div class="check-box"></div>
                    <div class="bank-tag-container">
                        <span style="font-size:0.75rem; color:${isImBank ? 'var(--im-highlight)' : 'var(--text-muted)'}; text-transform:uppercase; letter-spacing:1px; font-weight:700;">${p.bank} ${trend}</span>
                    </div>
                    <h3 class="prod-name" style="font-size:1.1rem; margin: 12px 0 24px 0; min-height:2.8rem; line-height:1.4;">${p.name}</h3>
                    <div class="rate-container" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <span style="color:var(--text-muted); font-size:0.8rem;">ìµœê³  ê¸ˆë¦¬</span>
                        <div class="rate-val" style="color:${isImBank ? 'var(--im-highlight)' : 'var(--success)'}; font-size:1.4rem; font-weight:800;">
                            ${p.rate2.toFixed(2)}%
                            <span class="diff-badge diff-${p.diff_score}">${diffText[p.diff_score]}</span>
                        </div>
                    </div>
                    <div class="profit-container" style="background:rgba(255,255,255,0.03); padding:12px; border-radius:12px; font-size:0.85rem;">
                        <span class="profit-label" style="color:var(--text-muted)">${profitText}:</span>
                        <span style="color:${isImBank ? 'var(--im-highlight)' : 'var(--success)'}; font-weight:700; float:right;">${currentCat.includes('credit') ? '' : '+'}${realProfit.toLocaleString()}ì›</span>
                    </div>
                `;
                card.onclick = (e) => {
                    if (e.target.closest('.check-box')) {
                        toggleSelect(p, card);
                    } else {
                        showDetail(p);
                    }
                };
                grid.appendChild(card);
            });
        }

        function showDetail(p) {
            const body = document.getElementById('modalBody');
            body.innerHTML = `
                <div style="margin-bottom:30px;">
                    <span style="color:var(--accent); font-weight:700;">${p.bank}</span>
                    <h2 style="font-size:2rem; margin-top:10px;">${p.name}</h2>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:30px;">
                    <div style="background:var(--glass); padding:20px; border-radius:20px;">
                        <div style="color:var(--text-muted); font-size:0.8rem; margin-bottom:5px;">ê¸°ë³¸ ê¸ˆë¦¬</div>
                        <div style="font-size:1.5rem; font-weight:700;">${p.rate.toFixed(2)}%</div>
                    </div>
                    <div style="background:rgba(16, 185, 129, 0.1); padding:20px; border-radius:20px;">
                        <div style="color:var(--success); font-size:0.8rem; margin-bottom:5px;">ìµœê³  ê¸ˆë¦¬</div>
                        <div style="font-size:1.5rem; font-weight:700; color:var(--success);">${p.rate2.toFixed(2)}%</div>
                    </div>
                </div>
                <div style="margin-bottom:20px;">
                    <h4 style="margin-bottom:10px; color:var(--text-muted);">ê°€ì… ë°©ë²•</h4>
                    <p>${p.join_way}</p>
                </div>
                <div>
                    <h4 style="margin-bottom:10px; color:var(--text-muted);">ìš°ëŒ€/ë§Œê¸° ì¡°ê±´</h4>
                    <p style="white-space:pre-wrap; line-height:1.6; font-size:0.95rem;">${p.etc_note}</p>
                </div>
            `;
            document.getElementById('detailModal').style.display = 'flex';
        }

        function toggleSelect(p, el) {
            const idx = selectedItems.findIndex(item => item.id === p.id);
            if (idx > -1) {
                selectedItems.splice(idx, 1);
                el.classList.remove('selected');
            } else {
                if (selectedItems.length >= 3) return alert('ìµœëŒ€ 3ê°œê¹Œì§€ë§Œ ë¹„êµ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                selectedItems.push(p);
                el.classList.add('selected');
            }
            updateCompareDrawer();
        }

        function updateCompareDrawer() {
            const drawer = document.getElementById('compareDrawer');
            const itemsCont = document.getElementById('compItems');
            const btn = document.getElementById('startCompBtn');
            const countLabel = document.getElementById('selectCount');

            if (selectedItems.length > 0) drawer.classList.add('active');
            else drawer.classList.remove('active');

            itemsCont.innerHTML = selectedItems.map(p => `
                <div class="comp-tag">${p.name.substring(0, 8)}... <button onclick="event.stopPropagation(); removeSelect('${p.id}')">&times;</button></div>
            `).join('');

            btn.textContent = `ìƒí’ˆ ë¹„êµí•˜ê¸° (${selectedItems.length}/3)`;
            countLabel.textContent = `${selectedItems.length}ê°œ ì„ íƒë¨`;
        }

        function removeSelect(id) {
            selectedItems = selectedItems.filter(p => p.id !== id);
            render();
            updateCompareDrawer();
        }

        document.getElementById('startCompBtn').onclick = () => {
            if (selectedItems.length < 2) return alert('ìµœì†Œ 2ê°œ ì´ìƒì˜ ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            const container = document.getElementById('compGridContainer');
            const rows = [
                { label: 'ì€í–‰', key: 'bank' },
                { label: 'ìƒí’ˆëª…', key: 'name' },
                { label: 'ìµœê³ ê¸ˆë¦¬', key: 'rate2', suffix: '%' },
                { label: 'ê°€ì…ë‚œì´ë„', key: 'diff_score', map: diffText },
                { label: 'ê°€ì…êµ¬ë¶„', key: 'join_way' },
                { label: 'ìš°ëŒ€ì¡°ê±´', key: 'etc_note' }
            ];

            let html = `<div class="comp-grid" style="grid-template-columns: 140px repeat(${selectedItems.length}, 1fr);">`;
            rows.forEach(row => {
                html += `<div class="comp-cell cell-head">${row.label}</div>`;
                selectedItems.forEach(p => {
                    let val = p[row.key];
                    if (row.suffix) val += row.suffix;
                    if (row.map) val = row.map[val];
                    html += `<div class="comp-cell">${val}</div>`;
                });
            });
            html += '</div>';
            container.innerHTML = html;
            document.getElementById('compModal').style.display = 'flex';
        };

        // Upload Logic
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const submitBtn = document.getElementById('submitUpload');
        const statusMsg = document.getElementById('statusMsg');
        let selectedFile = null;

        document.getElementById('openUploadBtn').onclick = () => document.getElementById('uploadModal').style.display = 'flex';
        document.getElementById('closeUpload').onclick = () => document.getElementById('uploadModal').style.display = 'none';

        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--accent)'; };
        dropZone.ondragleave = () => dropZone.style.borderColor = 'var(--border)';
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--border)';
            if (e.dataTransfer.files.length) {
                selectedFile = e.dataTransfer.files[0];
                document.getElementById('fileNameDisplay').textContent = selectedFile.name;
            }
        };

        fileInput.onchange = (e) => {
            if (e.target.files.length) {
                selectedFile = e.target.files[0];
                document.getElementById('fileNameDisplay').textContent = selectedFile.name;
            }
        };

        submitBtn.onclick = async () => {
            if (!selectedFile) return alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ì²˜ë¦¬ ì¤‘...';
            statusMsg.textContent = '';

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('category', document.getElementById('uploadCategory').value);

            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (res.ok) {
                    statusMsg.style.color = 'var(--success)';
                    statusMsg.textContent = 'âœ… ì—…ë°ì´íŠ¸ ì„±ê³µ!';
                    setTimeout(() => {
                        document.getElementById('uploadModal').style.display = 'none';
                        fetchProducts();
                    }, 1500);
                } else {
                    statusMsg.style.color = 'var(--error)';
                    statusMsg.textContent = 'âŒ ì—ëŸ¬: ' + data.error;
                }
            } catch (err) {
                statusMsg.style.color = 'var(--error)';
                statusMsg.textContent = 'âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹œì‘';
            }
        };

        // Common Modal Close
        window.onclick = (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.style.display = 'none';
            }
        };
        document.getElementById('closeDetail').onclick = () => document.getElementById('detailModal').style.display = 'none';

        // Nav Events
        document.querySelectorAll('.nav-btn').forEach(btn => btn.onclick = () => {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active'); currentCat = btn.dataset.cat;
            document.getElementById('viewTitle').textContent = catNames[currentCat];
            selectedItems = []; updateCompareDrawer(); fetchProducts();
        });

        document.getElementById('globalAmount').oninput = (e) => {
            let val = e.target.value.replace(/,/g, '');
            if (!isNaN(val)) e.target.value = Number(val).toLocaleString();
            render();
        };

        document.getElementById('termSelect').onchange = (e) => { currentTerm = e.target.value; fetchProducts(); };

        // View Toggle Logic
        const gridEl = document.getElementById('productGrid');
        const gridBtn = document.getElementById('gridToggle');
        const listBtn = document.getElementById('listToggle');

        gridBtn.onclick = () => {
            gridEl.classList.remove('list');
            gridBtn.classList.add('active'); gridBtn.style.background = 'var(--accent)'; gridBtn.style.color = 'white';
            listBtn.classList.remove('active'); listBtn.style.background = 'transparent'; listBtn.style.color = 'var(--text-muted)';
        };

        listBtn.onclick = () => {
            gridEl.classList.add('list');
            listBtn.classList.add('active'); listBtn.style.background = 'var(--accent)'; listBtn.style.color = 'white';
            gridBtn.classList.remove('active'); gridBtn.style.background = 'transparent'; gridBtn.style.color = 'var(--text-muted)';
        };

        fetchProducts(); // Initial Load
    </script>
</body>

</html>